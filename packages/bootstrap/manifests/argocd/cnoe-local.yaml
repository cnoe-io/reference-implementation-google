apiVersion: external-secrets.io/v1
kind: ExternalSecret
metadata:
  annotations:
    argocd.argoproj.io/sync-options: SkipDryRunOnMissingResource=true
  name: cnoe-local
spec:
  refreshInterval: 1m
  secretStoreRef:
    name: cnoe-kubeconfig
    kind: ClusterSecretStore
  target:
    name: cnoe-bootstrap
    creationPolicy: Owner
    template:
      engineVersion: v2
      type: Opaque
      metadata:
        labels:
          argocd.argoproj.io/secret-type: cluster
          cnoe.io/cluster: bootstrap
          environment: "control-plane"
        annotations:
          cnoe.io/cluster: bootstrap
          environment: "control-plane"
          addonsRepoURL: "{{ (fromJson .config).repo.url }}"
          addonsRepoRevision: "{{ (fromJson .config).repo.revision }}"
          addonsRepoBasepath: "{{ (fromJson .config).repo.basepath }}"
          project: "{{ (fromJson .config).project }}"
          region: "{{ (fromJson .config).region }}"
          clusterName: "{{ (fromJson .config).cluster_name }}"
          dnsZone: "{{ (fromJson .config).dns_zone }}"
          dnsDomain: "{{ (fromJson .config).dns_domain }}"
          secretManager: "{{ (fromJson .config).secret_manager }}"
          letsencryptEnv: "{{ (fromJson .config).letsencrypt_env }}"
          pathRouting: "{{ (fromJson .config).path_routing }}"
          cnoeClusterUrl: "{{ (first (fromYaml .kubeconfig).clusters).cluster.server }}"
          gcpServiceAccount: "{{ .gcpServiceAccount }}"
      data:
        name: "{{ (fromJson .config).cluster_name }}-bootstrap"
        server: https://kubernetes.default.svc
  data:
    - secretKey: config
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: Auto
        metadataPolicy: None
        key: cnoe-config
        property: "config.json"
    - secretKey: kubeconfig
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: Auto
        metadataPolicy: None
        key: cnoe-kubeconfig
        property: kubeconfig
    - secretKey: gcpServiceAccount
      remoteRef:
        conversionStrategy: Default
        decodingStrategy: Auto
        metadataPolicy: None
        key: provider-gcp
        property: clientEmail
